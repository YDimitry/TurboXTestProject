<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <script type="text/javascript" src="./cytoscapemin.js"></script>
    <script type="text/javascript" src="base.js"></script>
    <link href="./Cytoscapejs.css" rel="style" type="text/css"/>
    <style>
        body {
            font-family: helvetica neue, helvetica, liberation sans, arial, sans-serif;
            font-size: 14px;
        }

        #cy {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 999;
        }

        h1 {
            opacity: 0.5;
            font-size: 1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="cy"></div>
<div id="flow" style="height: 300px;"></div>
</body>

<script type="text/javascript" >
    document.addEventListener('DOMContentLoaded', loadCy);


    var x1;
    var iX;
    var xZ1;
    var iXU;
    var initLev;
    iXU = 0;
    iX = 0;
    Wd = 400;
    Hd = 280;
    var nodeClick;
    var FdblClick = 0;
    var Ynode_max = [];
    Ynode_min = 300;
    var FEnd = false;
    var MASnode = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];

    function loadCy() {
        var dom = document.getElementsByTagName('*');
        var km = ['click', 'dblclick', 'mousedown', 'mousemove', 'mouseover', 'mouseout', 'mouseup', 'mouseenter', 'mouseleave', 'keydown', 'keypress', 'keyup'];
        for (var i = 0, l = dom.length; i < l; i++) {
            for (var n = 0, c = km.length; n < c; n++) {
                dom[i]['on' + km[n]] = function (e) {
                    e = e || event;
                    e.preventDefault();
                    return false;
                }
            }
        }
        var fr = frames;
        for (var i = 0, l = fr.length; i < l; i++) {
// cancell frames events here
        }
// initialise cytoscape.js on a html dom element with some options:
        cy = window.cy = new cytoscape(
            options = {
                container: document.getElementById('cy'),
                wheelSensitivity: 0.1,
                minZoom: 0.1,
                maxZoom: 1,

// style can be specified as plain JSON, a stylesheet string (probably a CSS-like
// file pulled from the server), or in a functional format
                style: [{
                    selector: 'node',
                    style: {
                        'z-index-compare': 'manual',
                        'z-index': 2,
//'z-compound-depth': 'top',
                        'content': 'data(name)',
                        'font-family': 'verdana',
                        'font-size': 20,
                        'text-outline-width': 0,
                        'text-outline-color': 'white',
                        'text-valign': 'center',
//'text-justification': 'left',
                        'color': 'black', // цвет текста
                        'width': 'mapData(weight, 30, 80, 20, 50)',
                        'height': 'mapData(height, 0, 200, 10, 45)',

                        'shape': 'round-rectangle',
                        'height': Hd,
                        'width': Wd,
                        "border-opacity": "1",
                        "border-width": "8px",
                        "border-color": "black",
                        "background-color": "white"
                    } // style: {lineColor: '#9eefcf', 'width': 7}
                }, {
                    selector: 'edge',
                    style: {
                        'z-index-compare': 'manual',
                        'z-index': 1,
                        'width': 3,
                        'opacity': '0.5',
                        'line-color': 'black',
                        'length': 100,
                        'target-arrow-color': 'black',
                        'target-arrow-shape': 'vee', //'triangle',
                        'curve-style': 'taxi', //'straight'//'bezier'
                        'arrow-scale': 4,
                        "taxi-direction": "downward",
                        "taxi-turn-min-distance": 5
                    }
                }, {
                    selector: ':selected',
                    style: {
                        'background-color': '#9bcaef',
                        'line-color': '#9bcaef',
                        'target-arrow-color': '#9bcaef',
                        'text-outline-color': '#9bcaef'
                    }
                }, {
                    selector: '.foo',
                    style: {
                        'border-width': 2,
                        'border-color': '#9bcaef'
                    }
                }, {
                    selector: ".multiline-manual",
                    style: {
                        "text-wrap": "wrap"
                    }
                }, {
                    selector: ".multiline-auto",
                    style: {
                        "text-wrap": "wrap",
                        "text-max-width": 350
                    }
                }

                ],

            });
        // draw(13, '01.02 Курсы валют - год в колонках@02.04 Выручка в валюте пересчета - проверка@02.03 Выручка в валюте пересчета - все валюты в строках@02.04 Выручка в валюте пересчета - пример формулы в колонках@04.03 Доля выручки по проектам (доле выручки (руб.) в общей выручке)@04.07  ТЕСТОВАЯ ФОРМА Распределение ФОТ производственного персонала по проектам согласно трудозатратам (20 счет)@05.01 Отчет о ПиУ@06.02 ФА - накопленная маржа, тыс рублей@06.01 ФА - накопленная маржа, тыс рублей@06.03 ФА - накопленная маржа, тыс рублей 1@06.04 ФА - график водопад@01.01 Курсы валют + график изменения курса@06.04 WhatIf@', '1,2,1,3,1,4,2,5,2,6,3,7,3,8,3,9,3,10,3,11,12,1,13,12,', '0,1,1,1,2,2,2,2,2,2,2,1,2,', 11, 0, 0, false)
    };

    var Pos;
    var Xzoom;
    var Yzoom;
    // let m;
    var Y_max = [];
    var iY = [];

    var maxL;

    var NodeRadius0 = [];
    var NodeRadius1 = [];
    var NodeLevel = [];

    function drawTest(){


    }


    function draw(nodeCount, Name, ID1, Level1, Mid, Full, Cell, WebSide) {

        function SelectNodes0(aNode2, aNodeSel) {

            for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
                var Fnode = false;
                for (var j = 0, Count2 = NodeLevel.length; j < Count2; j++) {
                    if (NodeLevel[j] == aNode2[i]) {
                        Fnode = true;
                        break;
                    }
                }
                if (!Fnode) {
                    NodeLevel[NodeLevel.length] = aNode2[i];
                }
            }
            var Edge2 = [];
            for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
                Edge2[i] = aNode2[i].connectedEdges();
            }
            var Nodes = [];
            var k = 0;
            var Fnot = false;
            for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
                for (var j = 0, Count2 = Edge2[i].length; j < Count2; j++) {
                    if (Edge2[i][j].source().id() == aNode2[i].id()) {
                        Nodes[k] = Edge2[i][j].target();
                        for (var r = 0, Count3 = Nodes[k].length; r < Count3; r++) {
                            var Fnode = false;
                            for (var t = 0, Count4 = NodeLevel.length; t < Count4; t++) {
                                if (NodeLevel[t] == Nodes[k][r]) {
                                    Fnode = true;
                                }
                            }
                            if (!Fnode) {
                                NodeLevel[NodeLevel.length] = Nodes[k][r];
                                Nodes[k][r].animate({
                                    style: {
                                        backgroundColor: '#c0ecdd',
                                        "border-opacity": "1"
                                    }

                                });

                                Edge2[i][j].animate({
                                    style: {
                                        lineColor: '#19f09a',
                                        'width': 7,
                                        'z-index': 1,
                                    }

                                }, {
                                    duration: 0
                                });

                            }
                        }

                        k++;
                    }
                }
            }
            return Nodes;
        }

        function SelectNodes1(aNode2, aNodeSel) {

            for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
                var Fnode = false;
                for (var j = 0, Count2 = NodeLevel.length; j < Count2; j++) {
                    if (NodeLevel[j] == aNode2[i]) {
                        Fnode = true;
                        break;
                    }
                }
                if (!Fnode) {
                    NodeLevel[NodeLevel.length] = aNode2[i];
                }
            }
            var Edge2 = [];
            for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
                Edge2[i] = aNode2[i].connectedEdges();
            }
            var Nodes = [];
            var k = 0;
            for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
                for (var j = 0, Count2 = Edge2[i].length; j < Count2; j++) {
                    if (Edge2[i][j].target().id() == aNode2[i].id()) {
                        Nodes[k] = Edge2[i][j].source();
                        for (var r = 0, Count3 = Nodes[k].length; r < Count3; r++) {
                            var Fnode = false;
                            for (var t = 0, Count4 = NodeLevel.length; t < Count4; t++) {
                                if (NodeLevel[t] == Nodes[k][r]) {
                                    Fnode = true;
                                }
                            }
                            if (!Fnode) {
                                NodeLevel[NodeLevel.length] = Nodes[k][r];
                                Nodes[k].animate({
                                    style: {
                                        backgroundColor: '#fdfce0',
                                        "border-opacity": "1"
                                    } //

                                });

                                Edge2[i][j].animate({
                                    style: {
                                        lineColor: '#e7e573',
                                        'width': 7,
                                        'z-index': 1,
                                    } //

                                }, {
                                    duration: 0
                                });
                            }
                        }
                        k++;
                    }

                }
            }

            return Nodes;
        }

        var xm;
        xm = 0;
        initLev = 0;
        var XLevel = [];
        var tempLevel;

// create nodes
        var Label1 = Name.split('@');
        var Level = Level1.split(',');
        maxL = Math.max.apply(null, Level);
        var numbers = ID1.split(',');

        m = 1;
        k = 0;
        y2 = 0;
        tempX = 0;
        var count;
        count = 0;

        x1 = 0;
        tempLevel = Level[0];
        XLevel[tempLevel] = 0;

        var Lab1_1;
        var Lab2_1;
        var Lab3_1;
        var jXU;
        var jX;

        var LabCycle;
        var ColorCycle;
        var FCycle;
        for (var i = 1; i <= nodeCount; i++) {
            if (numbers[i] == numbers[i - 1]) {
                LabCycle = ' 🔄 ';
                ColorCycle = "#9eefcf";
                FCycle = false;
            } else {
                LabCycle = '';
                ColorCycle = "white";
                FCycle = true;
            }
            y1 = 400 * Level[i - 1] + 200;

            if ((Mid > 1) && i > 1) {

                if (i <= Mid) { // Справа от корневого элемента

                    if (Level[i - 1] > tempLevel) {
                        tempLevel = Level[i - 1];

                        if ((XLevel[tempLevel] > 0) && (Pos != 1)) {
                            x1 = XLevel[tempLevel] + 1;
                        } else {
                            t = i - 1;
                            var Xcol = 0;
                            while ((Level[t] == tempLevel) && ((t + 1) <= Mid)) {
                                t++;
                                Xcol++;
                            }
                            x1 = xZ + Xcol;
//x1 = xZ - 1;
                        }
                        XLevel[tempLevel] = x1;
                    } else {
                        x1 = x1 - 1;
                        XLevel[tempLevel] = x1;
                    }

                    Pos = -1;
                } else { // Слева от корневого элемента
                    if ((Level[i - 1] != tempLevel) || (Pos == -1)) {
                        tempLevel = Level[i - 1];
                        if ((XLevel[tempLevel] > 0) && (Pos != -1)) {
                            x1 = XLevel[tempLevel] - 1;
                        } else {
                            t = i - 1;
                            var Xcol = 0;
                            while (Level[t] == tempLevel) {
                                t++;
                                Xcol++;
                            }
                            x1 = xZ - Xcol;
                            if (Math.abs(x1) > Math.abs(xm)) {
                                xm = x1; //Math.abs(x1);
                            }
                        }
                        XLevel[tempLevel] = x1;
                    } else {
                        x1 = x1 + 1;
                        XLevel[tempLevel] = x1;

                    }
                    Pos = 1;
                }

            } else {
                if (Full == 1) {
                    if (Level[i - 1] != tempLevel) {
                        tempLevel = Level[i - 1];
                        if (XLevel[tempLevel] > 0) {
                            x1 = XLevel[tempLevel] + 1;
                        } else {
                            x1 = xZ;
                        }
                        XLevel[tempLevel] = x1;
                    } else {
                        x1 = x1 + 1;
                        XLevel[tempLevel] = x1;
                    }
                } else {

                    if (Level[i - 1] != tempLevel) {
                        tempLevel = Level[i - 1];
                        if (XLevel[tempLevel] > 0) {
                            x1 = XLevel[tempLevel] + 1;
                        } else {
                            x1 = xZ;
                        }
                        XLevel[tempLevel] = x1;
                    } else {
                        x1 = x1 + 1;
                        XLevel[tempLevel] = x1;
                    }
                }

            }
            var Lab1;
            var Lab2;
            var Lab3;

            cy.add([{
                group: 'nodes',
                data: {
                    id: i,
                    name: Label1[i - 1],
                },
                classes: 'multiline-auto',
                position: {
                    x: 500 * (Mid + x1),
                    y: 1.2 * y1
                }

            },
            ]);

            if (i == 1) {
                xZ = x1;
                yZ = y1;
                if (Full == 1) {
                    l1 = 0.4;
                    Mid = 1;
                } else {
                    l1 = 0.5;
                }
            }
            xZ1 = 500 * (Mid + xm);

        }

// create edges
        for (var j = 1, Count = numbers.length - 1; j < Count; j = j + 2) {
            if ((cy.getElementById(numbers[j - 1]).length != 0) && (cy.getElementById(numbers[j]).length != 0)) {
                if (numbers[j] != numbers[j - 1]) {
                    cy.add([{
                        group: 'edges',
                        data: {
                            id: j + '-edge',
                            source: numbers[j - 1],
                            target: numbers[j]
                        }
                    }
                    ]);
                }
            }
        }
        if (Full == 1) {
            Xzoom = -200 * (xZ + Mid);
            Yzoom = 0;
        } else {
            Xzoom = -(xZ1 - Wd / 1.5); //-400 * (Mid - xm) + 200;
            Yzoom = -yZ + 150;
        }
        cy.zoom({
            level: l1, // the zoom level
            position: {
                x: Xzoom,
                y: Yzoom
            }
        });

        cy.dblclick();
        cy.on('dblclick', 'node', function (evt) {
            NodeRadius0 = [];
            NodeRadius1 = [];
            var node = evt.target;
            nodeClick = node;
            FdblClick = 1;
            passEvent('doubleClick', JSON.stringify(node.id()));

        });

        function sleep(milliseconds) {
            var date = Date.now();
            var currentDate = null;
            do {
                currentDate = Date.now();
            } while (currentDate - date < milliseconds);
        };
        cy.nodes().style({
            "font-size": "25px"
        });
        cy.on('select', 'edge', function (evt) {
            NodeRadius0 = [];
            NodeRadius1 = [];
            var edge = evt.target;

            cy.edges().animate({
                style: {
                    'width': 0
                }
            }, {
                duration: 0
            });

            cy.nodes().animate({
                style: { // lineColor: '#4ec696',
                    'z-index': 2,
                    "border-opacity": "0.1" // "border-opacity": "0.2"
                }
            }, {
                duration: 0
            });

            var Nodes1 = edge.connectedNodes().animate({
                style: {
//lineColor: '#4ec696',
                    "border-opacity": "1",
                    'z-index': 3,
                }
            }, {
                duration: 0
            });
            edge.animate({
                style: {
                    'width': 8,
                    'z-index': 5,
                    lineColor: '#217bc0'
                }
            }, {
                duration: 0
            });

            var ID5 = [];
            for (var i = 1; i <= Nodes1.length; i++) {
                ID5[i - 1] = Nodes1[i - 1].id();
            }

            for (var i = 1; i <= Nodes1.length; i++) {
                var Source1 = ID5[i - 1];
                for (var k = 1; k <= Nodes1.length; k++) {
                    for (var j = 1; j < numbers.length - 1; j = j + 2) {
                        if ((numbers[j - 1] == Source1) && (numbers[j] == ID5[k - 1])) {
//  if (ID5[i - 1] != IDclick) {
                            Nodes1[i - 1].animate({ //  style({

                                style: {
                                    backgroundColor: '#f6f28a',
                                    "border-opacity": "1"
                                } // желтый

                            }, {
                                duration: 0
                            });

                            Nodes1[k - 1].animate({ //  style({

                                style: {
                                    backgroundColor: '#9eefcf',
                                    "border-opacity": "1"
                                } // зелёный

                            });
                        }
                    }
                }
            }
        });

        cy.on('select', 'node', function (evt) {
            NodeRadius0 = [];
            NodeRadius1 = [];
            var node = evt.target;
            var StrTemp = node.id();
            for (var i = 0; i < 5; i++) {
                var IDstrTemp = StrTemp.split(MASnode[i]);
                if (IDstrTemp.length > 1) {
                    node = cy.getElementById(IDstrTemp[1]);
                }
            }
            cy.edges().animate({
                style: {
                    'width': 0

                }
            }, {
                duration: 0
            });

            cy.nodes().animate({
                style: {
                    'z-index': 5,
                    "border-opacity": "0.1"
                }
            }, {
                duration: 0
            });

            node.connectedEdges().animate({
                style: {
                    lineColor: '#4ec696',
                    'width': 7,
                    'z-index': 1,
                }
            }, {
                duration: 0
            });

            var edge1 = node.connectedEdges();
            var IDclick = node.id();
            var edgeID = edge1.id();
            var Nodes1 = edge1.connectedNodes().style({

                backgroundColor: 'white'

            });

            node.animate({
                style: {
                    backgroundColor: '#9bcaef',
                    "border-opacity": "1"
                }
            }, {
                duration: 0
            });

            for (var m = 1; m <= 5; m++) {
                cy.getElementById(MASnode[m - 1] + node.id()).animate({ //  style({

                    style: {
                        backgroundColor: '#9bcaef',
                        "border-opacity": "1"
                    } // желтый

                }, {
                    duration: 0
                });

            }
            var ID5 = [];
            for (var i = 1; i <= Nodes1.length; i++) {
                ID5[i - 1] = Nodes1[i - 1].id();
            }
            var p = 0;
            var t = 0;
            for (var i = 1; i <= Nodes1.length; i++) {
                var Source1 = ID5[i - 1];
                for (var k = 1; k <= Nodes1.length; k++) {
                    for (var j = 1; j < numbers.length - 1; j = j + 2) {
                        if ((numbers[j - 1] == Source1) && (numbers[j] == ID5[k - 1])) {
                            if (ID5[i - 1] != IDclick) {
                                NodeRadius1[p] = Nodes1[i - 1];
                                p++;
                                Nodes1[i - 1].animate({ //  style({

                                    style: {
                                        backgroundColor: '#f6f28a',
                                        "border-opacity": "1"
                                    } // желтый
                                }, {
                                    duration: 0
                                });
                                Nodes1[i - 1].connectedEdges().animate({
                                    style: {
                                        lineColor: '#e8e102'
                                    }
                                }, {
                                    duration: 0
                                });

                            }
                            if (ID5[k - 1] != IDclick) {
                                NodeRadius0[t] = Nodes1[k - 1];
                                t++;
                                Nodes1[k - 1].animate({ //  style({
                                    style: {
                                        backgroundColor: '#70d7ad',
                                        "border-opacity": "1"
                                    } // зелёный

                                });
                                Nodes1[k - 1].connectedEdges().animate({ //  style({

                                    style: {
                                        lineColor: '#0c8856'
                                    } // зелёный

                                }, {
                                    duration: 0
                                });

                            }
                        }
                    }
                }
            }
            NodeLevel.push(node);
            for (var i = 1, Count = (2 * maxL); i < Count; i++) {
                NodeRadius1 = SelectNodes1(NodeRadius1, node, FEnd);
                NodeRadius0 = SelectNodes0(NodeRadius0, node, FEnd);
            }
            NodeLevel.length = 0;
            NodeRadius0.lebgth = 0;
            NodeRadius1.lebgth = 0;
        });

        cy.on('unselect', function (evt) {
            NodeRadius0 = [];
            NodeRadius1 = [];
            cy.edges().removeStyle();
            cy.nodes().removeStyle();
            cy.nodes().style({
                "font-size": "25px"
            });
        });

        function passEvent(eventName, eventParams) {
            loadCy();
            if (!WebSide) {
                window.open('turbo://' + eventName + '?Params=' + eventParams + Cell + nodeClick.data("name"));
            } else {

            }
        }

    };


//     function drawGaudge(Name, WebSide) {
// // create nodes
//         let Label1 = Name.split('@');
//
//         let nodeCountX = (Label1.length - 1) / 2;
//
//
//         x1 = 0;
//         var k = 0;
//         y1 = 200;
//         for (var i = 1; i <= nodeCountX; i++) {
//
//             if ((i % 4) == 0) {
//                 y1 = y1 + 600;
//                 x1 = 0;
//             } else {
//             }
//             x1 = x1 + 2;
//
//             cy.add([{
//                 group: 'nodes',
//                 data: {
//                     id: i,
//                 },
//                 style: {
//                     'border-width': 0.1,
//                     'opacity': 1,
//                     'border-color': 'white'
//                 },
//                 scratch: {
//                     _foo: 'bar'
//                 },
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 500 * x1,
//                     y: 1.2 * y1
//                 }
//
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'a' + i,
//                     parent: i,
//                     name: Label1[k],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'black',
//                     "font-size": "40px",
//                     'width': 650,
//                     selector: ".multiline-auto",
//                     style: {
//                         "text-wrap": "wrap",
//                         "text-max-width": 500
//                     }
//                 },
//                 selectable: false,
//
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 500 * x1,
//                     y: 1.2 * y1
//                 }
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'b' + i,
//                     parent: i,
//                     name: Label1[k + 1],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'black',
//                     "font-size": "40px",
//                     'width': 650,
//                     selector: ".multiline-auto",
//                     style: {
//                         "text-wrap": "wrap",
//                         "text-max-width": 500
//                     }
//                 },
//                 selectable: false,
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 500 * x1,
//                     y: 1.2 * y1 + 280
//                 }
//             },
//
//             ]);
//             if (i == 1) {
//                 xZ = x1;
//                 yZ = y1;
//                 l1 = 0.5;
//             }
//             xZ1 = 500;
//             k = k + 2;
//         }
//         Xzoom = -(xZ1 - Wd / 1.5);
//         Yzoom = -yZ + 150;
//
//         cy.zoom({
//             level: l1,
//             position: {
//                 x: Xzoom,
//                 y: Yzoom
//             }
//         });
//     }


//     function drawCell(nodeCount, Name, ID1, Level1, Mid) { // Full, Cell, WebSide,
//
//         iX = 0;
//         var xm;
//         xm = 0;
//         var XLevel = [];
//         var tempLevel;
//
// // create nodes
//         let Label1 = Name.split('@');
//         let Level = Level1.split(',');
//         maxL = Math.max.apply(null, Level);
//         let numbers = ID1.split(',');
//
//         Ynode_max[0] = Ynode_min;
//         for (var i = 1; i <= maxL; i++) {
//             iY[i] = 1.4;
//         }
//         iY[0] = 0.7;
//
//         x1 = 0;
//
//         tempLevel = Level[0];
//         XLevel[tempLevel] = 0;
//
//         var Lab1_1;
//         var Lab2_1;
//         var Lab3_1;
//         var jXU;
//         var jX;
//
//         var LabCycle;
//         var ColorCycle;
//         var FCycle;
//         for (var i = 1; i <= nodeCount; i++) {
//             if (numbers[i] == numbers[i - 1]) {
//                 LabCycle = ' 🔄 ';
//                 ColorCycle = "#9eefcf";
//                 FCycle = false;
//             } else {
//                 LabCycle = '';
//                 ColorCycle = "white";
//                 FCycle = true;
//             }
//             y1 = 400 * Level[i - 1] + 200;
//
//             if ((Mid > 1) && i > 1) {
//
//                 if (i <= Mid) { // Справа от корневого элемента
//
//                     if (Level[i - 1] > tempLevel) {
//                         tempLevel = Level[i - 1];
//
//                         if ((XLevel[tempLevel] > 0) && (Pos != 1)) {
//                             x1 = XLevel[tempLevel] + 1;
//                         } else {
//                             t = i - 1;
//                             var Xcol = 0;
//                             while ((Level[t] == tempLevel) && ((t + 1) <= Mid)) {
//                                 t++;
//                                 Xcol++;
//                             }
//                             x1 = xZ + Xcol;
// //x1 = xZ - 1;
//                         }
//                         XLevel[tempLevel] = x1;
//                     } else {
//                         x1 = x1 - 1;
//                         XLevel[tempLevel] = x1;
//                     }
//
//                     Pos = -1;
//                 } else { // Слева от корневого элемента
//                     if ((Level[i - 1] != tempLevel) || (Pos == -1)) {
//                         tempLevel = Level[i - 1];
//                         if ((XLevel[tempLevel] > 0) && (Pos != -1)) {
//                             x1 = XLevel[tempLevel] - 1;
//                         } else {
//                             t = i - 1;
//                             var Xcol = 0;
//                             while (Level[t] == tempLevel) {
//                                 t++;
//                                 Xcol++;
//                             }
//                             x1 = xZ - Xcol;
//                             if (Math.abs(x1) > Math.abs(xm)) {
//                                 xm = x1; //Math.abs(x1);
//                             }
//                         }
//                         XLevel[tempLevel] = x1;
//                     } else {
//                         x1 = x1 + 1;
//                         XLevel[tempLevel] = x1;
//
//                     }
//                     Pos = 1;
//                 }
//
//             } else {
//
//                 if (Level[i - 1] != tempLevel) {
//                     tempLevel = Level[i - 1];
//                     if (XLevel[tempLevel] > 0) {
//                         x1 = XLevel[tempLevel] + 1;
//                     } else {
//                         x1 = xZ;
//                     }
//                     XLevel[tempLevel] = x1;
//                 } else {
//                     x1 = x1 + 1;
//                     XLevel[tempLevel] = x1;
//                 }
//
//             }
//
//             var jXU;
//             var jX;
//             iXU = i + iX;
//
//             cy.add([{
//                 group: 'nodes',
//                 data: {
//                     id: i,
//                 },
//                 style: {
//                     'border-width': 0.1,
//                     'opacity': 1,
//                     'border-color': 'white'
//                 },
//                 scratch: {
//                     _foo: 'bar'
//                 },
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 600 * (Mid + x1),
//                     y: 2 * y1 * iY[Level[i - 1]]
//                 }
//
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'a' + i, // Дата
//                     parent: i,
//                     name: LabCycle + Label1[iXU - 1],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'black', // цвет текста
//                     'height': 50,
//                     "background-color": ColorCycle,
//                 },
//
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 600 * (Mid + x1),
//                     y: 2 * y1 * iY[Level[i - 1]]
//                 }
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'b' + i, // Имя
//                     parent: i,
//                     name: Label1[iXU],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'black', // цвет текста
//                     'height': 50 * (Label1[iXU].length / 21),
//                 },
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 600 * (Mid + x1),
//                     y: 2 * y1 * iY[Level[i - 1]] + 25 + 25 * ((Label1[iXU].length / 21))
//                 }
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'c' + i, // Формула расчёта
//                     parent: i,
//                     name: Label1[iXU + 1],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'black', // цвет текста
//                     'height': 50 * (Label1[iXU + 1].length / 21),
//                 },
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 600 * (Mid + x1),
//                     y: 2 * y1 * iY[Level[i - 1]] + 25 + 50 * ((Label1[iXU].length / 21)) + 25 * (Label1[iXU + 1].length / 21)
//                 }
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'd' + i, // Значение
//                     parent: i,
//                     name: Label1[iXU + 2],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'blue', // цвет текста
//                     'height': 100,
//                     "text-wrap": "wrap",
//                     "text-max-width": 50
//                 },
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 600 * (Mid + x1),
//                     y: 2 * y1 * iY[Level[i - 1]] + 25 + 50 * ((Label1[iXU].length / 21)) + 50 * (Label1[iXU + 1].length / 21) + 50
//                 }
//             }, {
//                 group: 'nodes',
//                 data: {
//                     id: 'e' + i, // Срез
//                     parent: i,
//                     name: Label1[iXU + 3],
//                 },
//                 pannable: true,
//                 style: {
//                     'color': 'red', // цвет текста
//                     'height': 50 * (Label1[iXU + 3].length / 21),
//                     "text-wrap": "wrap",
//                     "text-max-width": 300
//                 },
//                 classes: 'multiline-auto',
//                 position: {
//                     x: 600 * (Mid + x1),
//                     y: 2 * y1 * iY[Level[i - 1]] + 25 + 50 * ((Label1[iXU].length / 21)) + 50 * (Label1[iXU + 1].length / 21) + 100 + 25 * (Label1[iXU + 3].length / 21)
//                 }
//             },
//             ]);
//             iX = iX + 4;
//
//             if (i == 1) {
//                 xZ = x1;
//                 yZ = y1;
//                 l1 = 0.5;
//
//             }
//             xZ1 = 600 * (Mid + xm);
//         }
//
// // create edges
//         for (var j = 1, Count = numbers.length - 1; j < Count; j = j + 2) {
//             if (numbers[j] != numbers[j - 1]) {
//                 if ((cy.getElementById(numbers[j - 1]).length != 0) && (cy.getElementById(numbers[j]).length != 0)) {
//                     cy.add([{
//                         group: 'edges',
//                         data: {
//                             id: j + '-edge',
//                             source: numbers[j - 1],
//                             target: numbers[j]
//                         }
//                     }
//                     ]);
//                 }
//
//             }
//         }
//
//         Xzoom = -(xZ1 - Wd / 1.8);
//         Yzoom = -yZ;
//
//         cy.zoom({
//             level: l1,
//             position: {
//                 x: Xzoom,
//                 y: Yzoom
//             }
//         });
//
//         cy.dblclick();
//         cy.on('dblclick', 'node', function (evt) {
//             NodeRadius0 = [];
//             NodeRadius1 = [];
//             var node = evt.target;
//             nodeClick = node;
//             FdblClick = 1;
//             passEvent('doubleClick', JSON.stringify(node.id()));
//
//         });
//
//         function sleep(milliseconds) {
//             const date = Date.now();
//             let currentDate = null;
//             do {
//                 currentDate = Date.now();
//             } while (currentDate - date < milliseconds);
//         };
//         cy.nodes().style({
//             "font-size": "25px"
//         });
//         cy.on('select', 'edge', function (evt) {
//             NodeRadius0 = [];
//             NodeRadius1 = [];
//             var edge = evt.target;
//
//             cy.edges().animate({
//                 style: {
//                     'width': 0
//                 }
//             }, {
//                 duration: 0
//             });
//
//             cy.nodes().animate({
//                 style: { // lineColor: '#4ec696',
//                     'z-index': 2,
//                     "border-opacity": "0.1" // "border-opacity": "0.2"
//                 }
//             }, {
//                 duration: 0
//             });
//
//             var Nodes1 = edge.connectedNodes().animate({
//                 style: {
// //lineColor: '#4ec696',
//                     "border-opacity": "1",
//                     'z-index': 3,
//                 }
//             }, {
//                 duration: 0
//             });
//             edge.animate({
//                 style: {
//                     'width': 8,
//                     'z-index': 5,
//                     lineColor: '#217bc0'
//                 }
//             }, {
//                 duration: 0
//             });
//
//             var ID5 = [];
//             for (var i = 1, Count1 = Nodes1.length; i <= Count1; i++) {
//                 ID5[i - 1] = Nodes1[i - 1].id();
//             }
//
//             for (var i = 1, Count1 = Nodes1.length; i <= Count1; i++) {
//                 var Source1 = ID5[i - 1];
//                 for (var k = 1, Count2 = Nodes1.length; k <= Count2; k++) {
//                     for (var j = 1, Count3 = numbers.length - 1; j < Count3; j = j + 2) {
//                         if ((numbers[j - 1] == Source1) && (numbers[j] == ID5[k - 1])) {
//
//                             for (var m = 1; m <= 5; m++) {
//                                 cy.getElementById(MASnode[m - 1] + Nodes1[i - 1].id()).animate({ //  style({
//
//                                     style: {
//                                         backgroundColor: '#f6f28a',
//                                         "border-opacity": "1"
//                                     } // желтый
//
//                                 }, {
//                                     duration: 0
//                                 });
//
//                                 cy.getElementById(MASnode[m - 1] + Nodes1[k - 1].id()).animate({ //  style({
//
//                                     style: {
//                                         backgroundColor: '#9eefcf',
//                                         "border-opacity": "1"
//                                     } // зелёный
//
//                                 }, {
//                                     duration: 0
//                                 });
//                             }
//
//                         }
//                     }
//                 }
//             }
//         });
//
//         cy.on('select', 'node', function (evt) {
//             NodeRadius0 = [];
//             NodeRadius1 = [];
//             var node = evt.target;
//             var StrTemp = node.id();
//             for (var i = 0; i < 5; i++) {
//                 var IDstrTemp = StrTemp.split(MASnode[i]);
//                 if (IDstrTemp.length > 1) {
//                     node = cy.getElementById(IDstrTemp[1]);
//                 }
//             }
//             cy.edges().animate({
//                 style: {
//                     'width': 0
//                 }
//             }, {
//                 duration: 0
//             });
//
//             node.connectedEdges().animate({
//                 style: {
//                     lineColor: '#4ec696',
//                     'width': 7,
//                     'z-index': 1,
//                 }
//             }, {
//                 duration: 0
//             });
//
//             var edge1 = node.connectedEdges();
//             var IDclick = node.id();
//             var edgeID = edge1.id();
//             var Nodes1 = edge1.connectedNodes();
//
//             for (var m = 1; m <= 5; m++) {
//                 cy.getElementById(MASnode[m - 1] + node.id()).animate({
//                     style: {
//                         backgroundColor: '#9bcaef',
//                         "border-opacity": "1"
//                     }
//                 }, {
//                     duration: 0
//                 });
//             }
//             var ID5 = [];
//             for (var i = 1, Count1 = Nodes1.length; i <= Count1; i++) {
//                 ID5[i - 1] = Nodes1[i - 1].id();
//             }
//             var p = 0;
//             var t = 0;
//             for (var i = 1, Count1 = Nodes1.length; i <= Count1; i++) {
//                 var Source1 = ID5[i - 1];
//                 for (var k = 1, Count2 = Nodes1.length; k <= Count2; k++) {
//                     for (var j = 1, Count3 = numbers.length - 1; j < Count3; j = j + 2) {
//                         if ((numbers[j - 1] == Source1) && (numbers[j] == ID5[k - 1])) {
//                             if (ID5[i - 1] != IDclick) {
//                                 NodeRadius1[p] = Nodes1[i - 1];
//                                 p++;
//                                 Nodes1[i - 1].connectedEdges().animate({
//                                     style: {
//                                         lineColor: '#e8e102'
//                                     }
//                                 }, {
//                                     duration: 0
//                                 });
//
//                                 for (var m = 1; m <= 5; m++) {
//                                     cy.getElementById(MASnode[m - 1] + Nodes1[i - 1].id()).animate({ //  style({
//
//                                         style: {
//                                             backgroundColor: '#f6f28a',
//                                             "border-opacity": "1"
//                                         } // желтый
//
//                                     }, {
//                                         duration: 0
//                                     });
//
//                                 }
//
//                             }
//                             if (ID5[k - 1] != IDclick) {
//                                 NodeRadius0[t] = Nodes1[k - 1];
//                                 t++;
//                                 Nodes1[k - 1].connectedEdges().animate({ //  style({
//
//                                     style: {
//                                         lineColor: '#0c8856'
//                                     } // зелёный
//
//                                 }, {
//                                     duration: 0
//                                 });
//
//                                 for (var m = 1; m <= 5; m++) {
// // for (var m = 1; m <= 5; m++) {
//
//                                     cy.getElementById(MASnode[m - 1] + Nodes1[k - 1].id()).animate({ //  style({
//
//                                         style: {
//                                             backgroundColor: '#70d7ad',
//                                             "border-opacity": "1"
//                                         } // зелёный
//
//                                     }, {
//                                         duration: 0
//                                     });
//
//                                 }
//
//                             }
//                         }
//                     }
//                 }
//             }
//             NodeLevel.push(node);
//             for (var i = 1, Count1 = 2 * maxL; i < Count1; i++) {
//                 NodeRadius1 = SelectNodes1(NodeRadius1, node, FEnd);
//                 NodeRadius0 = SelectNodes0(NodeRadius0, node, FEnd);
//             }
//             NodeLevel.length = 0;
//             NodeRadius0.lebgth = 0;
//             NodeRadius1.lebgth = 0;
//         });
//
//         cy.on('unselect', function (evt) {
// //NodeRadius0 = [];
// //NodeRadius1 = [];
//
//             cy.edges().removeStyle();
//             cy.nodes().animate({ //  style({
//                 style: {
//                     backgroundColor: '#ffffff',
//                     "border-opacity": "1"
//                 }
//             }, {
//                 duration: 0
//             });
//             cy.nodes().style({
//                 "font-size": "25px"
//             });
//             if (!FCycle) {
//                 for (var i = 1; i <= nodeCount; i++) {
//                     var NameTemp = cy.getElementById("a" + i).attr().name;
//                     var strTemp1 = NameTemp.split(' 🔄 ');
//                     if (strTemp1.length > 1) {
//                         cy.getElementById("a" + i).animate({ //  style({
//                             style: {
//                                 backgroundColor: '#9eefcf',
//                                 "border-opacity": "1"
//                             }
//                         }, {
//                             duration: 0
//                         });
//                     }
//                 }
//             }
//
//         });
//
//         function passEvent(eventName, eventParams) {
//             loadCy();
// //if (!WebSide){
//             window.open('turbo://' + eventName + '?Params=' + eventParams + 1 + nodeClick.data("name"));
// //}else{
//
// //}
//         }
//
//         function SelectNodes0(aNode2, aNodeSel) {
//
//             for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
//                 var Fnode = false;
//                 for (var j = 0, Count2 = NodeLevel.length; j < Count2; j++) {
//                     if (NodeLevel[j] == aNode2[i]) {
//                         Fnode = true;
//                         break;
//                     }
//                 }
//                 if (!Fnode) {
//                     NodeLevel[NodeLevel.length] = aNode2[i];
//                 }
//             }
//             var Edge2 = [];
//             for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
//                 Edge2[i] = aNode2[i].connectedEdges();
//             }
//             var Nodes = [];
//             var k = 0;
//             var Fnot = false;
//             for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
//                 for (var j = 0, Count2 = Edge2[i].length; j < Count2; j++) {
//                     if (Edge2[i][j].source().id() == aNode2[i].id()) {
//                         Nodes[k] = Edge2[i][j].target();
//                         for (var r = 0, Count3 = Nodes[k].length; r < Count3; r++) {
//                             var Fnode = false;
//                             for (var t = 0, Count4 = NodeLevel.length; t < Count4; t++) {
//                                 if (NodeLevel[t] == Nodes[k][r]) {
//                                     Fnode = true;
//                                 }
//                             }
//                             if (!Fnode) {
//                                 NodeLevel[NodeLevel.length] = Nodes[k][r];
//
//                                 Edge2[i][j].animate({
//                                     style: {
//                                         lineColor: '#19f09a',
//                                         'width': 7,
//                                         'z-index': 1,
//                                     }
//
//                                 }, {
//                                     duration: 0
//                                 });
//
//                                 for (var m = 0; m < 5; m++) {
//                                     cy.getElementById(MASnode[m] + Nodes[k][r].id()).animate({ //  style({
//                                         style: {
//                                             backgroundColor: '#c0ecdd',
//                                             "border-opacity": "1"
//                                         }
//                                     }, {
//                                         duration: 0
//                                     });
//                                 }
//
//                             }
//                         }
//
//                         k++;
//                     }
//                 }
//             }
//             return Nodes;
//         }
//
//         function SelectNodes1(aNode2, aNodeSel) {
//
//             for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
//                 var Fnode = false;
//                 for (var j = 0, Count2 = NodeLevel.length; j < Count2; j++) {
//                     if (NodeLevel[j] == aNode2[i]) {
//                         Fnode = true;
//                         break;
//                     }
//                 }
//                 if (!Fnode) {
//                     NodeLevel[NodeLevel.length] = aNode2[i];
//                 }
//             }
//             var Edge2 = [];
//             for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
//                 Edge2[i] = aNode2[i].connectedEdges();
//             }
//             var Nodes = [];
//             var k = 0;
//             for (var i = 0, Count1 = aNode2.length; i < Count1; i++) {
//                 for (var j = 0, Count2 = Edge2[i].length; j < Count2; j++) {
//                     if (Edge2[i][j].target().id() == aNode2[i].id()) {
//                         Nodes[k] = Edge2[i][j].source();
//                         for (var r = 0, Count3 = Nodes[k].length; r < Count3; r++) {
//                             var Fnode = false;
//                             for (var t = 0, Count4 = NodeLevel.length; t < Count4; t++) {
//                                 if (NodeLevel[t] == Nodes[k][r]) {
//                                     Fnode = true;
//                                 }
//                             }
//                             if (!Fnode) {
//                                 NodeLevel[NodeLevel.length] = Nodes[k][r];
//
//                                 Edge2[i][j].animate({
//                                     style: {
//                                         lineColor: '#e7e573',
//                                         'width': 7,
//                                         'z-index': 1,
//                                     } //
//
//                                 }, {
//                                     duration: 0
//                                 });
//
//                                 for (var m = 0; m < 5; m++) {
//                                     cy.getElementById(MASnode[m] + Nodes[k][r].id()).animate({ //  style({
//                                         style: {
//                                             backgroundColor: '#fdfce0',
//                                             "border-opacity": "1"
//                                         }
//
//                                     }, {
//                                         duration: 0
//                                     });
//
//                                 }
//
//                             }
//                         }
//                         k++;
//                     }
//
//                 }
//             }
//
//             return Nodes;
//         }
//
//     };

    // document.addEventListener('DOMContentLoaded', loadCy);


</script>
</html>
 